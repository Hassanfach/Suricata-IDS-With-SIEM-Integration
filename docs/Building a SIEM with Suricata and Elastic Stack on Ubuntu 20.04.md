# Building a SIEM with Suricata and Elastic Stack on Ubuntu 20.04

## Table of Contents

-   [Introduction](#introduction)
-   [Prerequisites](#prerequisites)
-   [Step 1 --- Installing Elasticsearch and
    Kibana](#step-1--installing-elasticsearch-and-kibana)
-   [Step 2 --- Configuring
    Elasticsearch](#step-2--configuring-elasticsearch)
    -   [Setting Up Elasticsearch
        Networking](#setting-up-elasticsearch-networking)
    -   [Starting Elasticsearch](#starting-elasticsearch)
    -   [Setting Up Elasticsearch
        Passwords](#setting-up-elasticsearch-passwords)
-   [Step 3 --- Configuring Kibana](#step-3--configuring-kibana)
    -   [Enabling xpack Security in
        Kibana](#enabling-xpack-security-in-kibana)
    -   [Setting Up Kibana Networking](#setting-up-kibana-networking)
    -   [Setting Up Kibana Credentials](#setting-up-kibana-credentials)
    -   [Starting Kibana](#starting-kibana)
-   [Step 4 --- Installing Filebeat](#step-4--installing-filebeat)
-   [Step 5 --- Exploring Kibana SIEM
    Dashboards](#step-5--exploring-kibana-siem-dashboards)
    -   [Connecting to Kibana via SSH](#connecting-to-kibana-via-ssh)
    -   [Navigating Kibana SIEM
        Dashboards](#navigating-kibana-siem-dashboards)
-   [Conclusion](#conclusion)

## Introduction

This guide walks you through creating a Security Information and Event
Management (SIEM) system using Suricata as an Intrusion Detection System
(IDS) integrated with the Elastic Stack (Elasticsearch, Kibana, and
Filebeat) on Ubuntu 20.04. A SIEM system collects, stores, and analyzes
security data to detect potential threats and suspicious activities
across your network and servers.

The components of this SIEM setup include: - **Elasticsearch**: Stores,
indexes, and searches security events generated by Suricata. -
**Kibana**: Provides a visual interface to explore and analyze security
event logs. - **Filebeat**: Processes Suricata's `eve.json` log file and
forwards events to Elasticsearch. - **Suricata**: Monitors network
traffic, logs suspicious activities, and can block malicious packets.

In this tutorial, you'll learn how to install and configure
Elasticsearch, Kibana, and Filebeat to build a functional SIEM. You'll
also set up an SSH tunnel to access Kibana's dashboards and monitor
Suricata's events and alerts.

## Prerequisites

Before you begin, ensure you have: - **Suricata Server**: An Ubuntu
20.04 server with Suricata installed and configured. If not set up,
follow [How to Install Suricata on Ubuntu
20.04](https://www.digitalocean.com/community/tutorials/how-to-install-suricata-on-ubuntu-20-04).
Ensure Suricata rules are configured to generate alerts (see
[Understanding Suricata
Signatures](https://www.digitalocean.com/community/tutorials/understanding-suricata-signatures)). -
**Elasticsearch Server**: A second Ubuntu 20.04 server with: - 4GB RAM
and 2 CPUs. - A non-root user with sudo privileges (refer to [Initial
Server Setup with Ubuntu
20.04](https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-20-04)). -
Private network connectivity between servers (e.g., via a VPN like
WireGuard or a cloud provider's private networking). Alternatively, you
can run all components on a single server for testing. - **Network
Setup**: Both servers must communicate using private IP addresses. -
**Firewall**: Configured to allow required traffic (instructions
provided in later steps).

## Step 1 --- Installing Elasticsearch and Kibana

Start by installing Elasticsearch and Kibana on your Elasticsearch
server to handle storage and visualization of Suricata logs.

1.  Add the Elastic GPG key:

    ``` bash
    curl -fsSL https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
    ```

2.  Add the Elastic source list to
    `/etc/apt/sources.list.d/elastic-7.x.list`:

    ``` bash
    echo "deb https://artifacts.elastic.co/packages/7.x/apt stable main" | sudo tee -a /etc/apt/sources.list.d/elastic-7.x.list
    ```

3.  Update the package index and install Elasticsearch and Kibana:

    ``` bash
    sudo apt update
    sudo apt install -y elasticsearch kibana
    ```

4.  Check your Elasticsearch server's private IP address:

    ``` bash
    ip -brief address show
    ```

    Example output:

        lo               UNKNOWN        127.0.0.1/8 ::1/128
        eth0             UP             159.89.122.115/20 10.20.0.8/16 2604:a880:cad:d0::e56:8001/64
        eth1             UP             10.137.0.5/16 fe80::b883:5bff:fe19:43f3/64

    Note the private IP (e.g., `10.137.0.5`) and interface (e.g.,
    `eth1`). Replace `your_private_ip` with this address in subsequent
    steps.

## Step 2 --- Configuring Elasticsearch

Configure Elasticsearch to allow connections from the Suricata server
and enable secure authentication.

### Setting Up Elasticsearch Networking

By default, Elasticsearch only accepts local connections. You need to
configure it to listen on the private network interface.

1.  Open the Elasticsearch configuration file:

    ``` bash
    sudo nano /etc/elasticsearch/elasticsearch.yml
    ```

2.  Find the `#network.host: 192.168.0.1` line (around lines 50--60) and
    add:

    ``` yaml
    network.bind_host: ["127.0.0.1", "your_private_ip"]
    ```

    Replace `your_private_ip` with your server's private IP address.

3.  At the end of the file, add:

    ``` yaml
    discovery.type: single-node
    xpack.security.enabled: true
    ```

    -   `discovery.type: single-node` sets Elasticsearch to run as a
        single node.
    -   `xpack.security.enabled: true` activates security features.

4.  Save and close the file (`CTRL+X`, `Y`, `ENTER` in nano).

5.  Allow traffic on the private network interface using Uncomplicated
    Firewall (ufw):

    ``` bash
    sudo ufw allow in on eth1
    sudo ufw allow out on eth1
    ```

    Replace `eth1` with your private network interface if different.

### Starting Elasticsearch

Launch Elasticsearch to apply the changes:

``` bash
sudo systemctl start elasticsearch.service
```

Verify the service is running:

``` bash
sudo systemctl status elasticsearch.service
```

### Setting Up Elasticsearch Passwords

Generate passwords for Elasticsearch's default users to secure
communication.

1.  Navigate to the Elasticsearch bin directory:

    ``` bash
    cd /usr/share/elasticsearch/bin
    ```

2.  Generate random passwords:

    ``` bash
    sudo ./elasticsearch-setup-passwords auto
    ```

    Example output:

        Changed password for user apm_system
        PASSWORD apm_system = eWqzd0asAmxZ0gcJpOvn
        Changed password for user kibana_system
        PASSWORD kibana_system = 1HLVxfqZMd7aFQS6Uabl
        Changed password for user kibana
        PASSWORD kibana = 1HLVxfqZMd7aFQS6Uabl
        Changed password for user logstash_system
        PASSWORD logstash_system = wUjY59H91WGvGaN8uFLc
        Changed password for user beats_system
        PASSWORD beats_system = 2p81hIdAzWKknhzA992m
        Changed password for user remote_monitoring_user
        PASSWORD remote_monitoring_user = 85HF85Fl6cPslJlA8wPG
        Changed password for user elastic
        PASSWORD elastic = 6kNbsxQGYZ2EQJiqJpgl

    Store these passwords securely. You'll need the `kibana_system` and
    `elastic` passwords for later steps.

## Step 3 --- Configuring Kibana

Set up Kibana to connect with Elasticsearch and enable secure access.

### Enabling xpack Security in Kibana

Generate encryption keys for Kibana to store session data and
dashboards.

1.  Navigate to the Kibana bin directory:

    ``` bash
    cd /usr/share/kibana/bin/
    ```

2.  Generate encryption keys:

    ``` bash
    sudo ./kibana-encryption-keys generate -q
    ```

    Example output:

        xpack.encryptedSavedObjects.encryptionKey: 66fbd85ceb3cba51c0e939fb2526f585
        xpack.reporting.encryptionKey: 9358f4bc7189ae0ade1b8deeec7f38ef
        xpack.security.encryptionKey: 8f847a594e4a813c4187fa93c884e92b

    Save these keys securely.

3.  Open the Kibana configuration file:

    ``` bash
    sudo nano /etc/kibana/kibana.yml
    ```

4.  Append the encryption keys to the end of the file:

    ``` yaml
    xpack.encryptedSavedObjects.encryptionKey: 66fbd85ceb3cba51c0e939fb2526f585
    xpack.reporting.encryptionKey: 9358f4bc7189ae0ade1b8deeec7f38ef
    xpack.security.encryptionKey: 8f847a594e4a813c4187fa93c884e92b
    ```

    Save and close the file.

### Setting Up Kibana Networking

Configure Kibana to listen on the private IP address.

1.  In `/etc/kibana/kibana.yml`, find `#server.host: "localhost"` (near
    the top) and add:

    ``` yaml
    server.host: "your_private_ip"
    ```

    Replace `your_private_ip` with your Elasticsearch server's private
    IP. Save and close the file.

### Setting Up Kibana Credentials

Use Kibana's keystore to securely store credentials for connecting to
Elasticsearch.

1.  Add the username to the keystore:

    ``` bash
    sudo ./kibana-keystore add elasticsearch.username
    ```

    Enter `kibana_system` when prompted.

2.  Add the password (use the `kibana_system` password from Step 2,
    e.g., `1HLVxfqZMd7aFQS6Uabl`):

    ``` bash
    sudo ./kibana-keystore add elasticsearch.password
    ```

    Paste the password to avoid typos.

### Starting Kibana

Start Kibana to apply the changes:

``` bash
sudo systemctl start kibana.service
```

Verify the service is running:

``` bash
sudo systemctl status kibana.service
```

## Step 4 --- Installing Filebeat

Install and configure Filebeat on the Suricata server to send logs to
Elasticsearch.

1.  Add the Elastic GPG key:

    ``` bash
    curl -fsSL https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
    ```

2.  Add the Elastic source list:

    ``` bash
    echo "deb https://artifacts.elastic.co/packages/7.x/apt stable main" | sudo tee -a /etc/apt/sources.list.d/elastic-7.x.list
    ```

3.  Update the package index and install Filebeat:

    ``` bash
    sudo apt update
    sudo apt install -y filebeat
    ```

4.  Configure Filebeat to connect to Kibana and Elasticsearch:

    ``` bash
    sudo nano /etc/filebeat/filebeat.yml
    ```

    -   In the Kibana section (around line 100), add:

        ``` yaml
        setup.kibana:
          host: "your_private_ip:5601"
        ```

        Replace `your_private_ip` with the Elasticsearch server's
        private IP.

    -   In the Elasticsearch Output section (around line 130),
        configure:

        ``` yaml
        output.elasticsearch:
          hosts: ["your_private_ip:9200"]
          username: "elastic"
          password: "6kNbsxQGYZ2EQJiqJpgl"
        ```

        Replace `your_private_ip` and the password with the `elastic`
        user's password from Step 2. Save and close the file.

5.  Enable the Suricata module:

    ``` bash
    sudo filebeat modules enable suricata
    ```

6.  Load SIEM dashboards and pipelines:

    ``` bash
    sudo filebeat setup
    ```

    This may take a few minutes. Expected output:

        Overwriting ILM policy is disabled. Set `setup.ilm.overwrite: true` for enabling.
        Index setup finished.
        Loading dashboards (Kibana must be running and reachable)
        Loaded dashboards
        Loaded Ingest pipelines

7.  Start Filebeat:

    ``` bash
    sudo systemctl start filebeat.service
    ```

    Verify the service is running:

    ``` bash
    sudo systemctl status filebeat.service
    ```

## Step 5 --- Exploring Kibana SIEM Dashboards

Access Kibana through an SSH tunnel to view Suricata's event and alert
dashboards.

### Connecting to Kibana via SSH

Since Kibana listens on the private IP, use an SSH tunnel to access it.

1.  From your local machine, create an SSH tunnel:

    ``` bash
    ssh -L 5601:your_private_ip:5601 user@public_ip -N
    ```

    -   Replace `your_private_ip` with the Elasticsearch server's
        private IP.
    -   Replace `public_ip` with the Elasticsearch server's public IP
        (e.g., `203.0.113.5`).
    -   Replace `user` with your admin user (e.g., `sammy`).
    -   The `-N` flag keeps the connection open without running a
        command.

2.  Open a browser and visit `http://127.0.0.1:5601`. Log in with the
    `elastic` username and its password from Step 2.

### Navigating Kibana SIEM Dashboards

1.  In Kibana's search bar, type `type:dashboard suricata` to locate:
    -   `[Filebeat Suricata] Events Overview`
    -   `[Filebeat Suricata] Alerts`
2.  Click `[Filebeat Suricata] Events Overview` to view all logged
    events.
3.  Access the `Alerts` dashboard via search or a link in the Events
    dashboard.
4.  Explore the `Network` dashboard under the Security menu for a
    map-based overview and aggregated network event data.
5.  Scroll to the bottom of each dashboard to view detailed event
    tables. Expand entries to inspect details like source/destination
    IPs, attack types, and Suricata rule IDs.
6.  Use Kibana's timeline feature to analyze specific traffic flows,
    alerts, or community IDs.

## Conclusion

You've successfully built a SIEM system using Suricata and the Elastic
Stack on Ubuntu 20.04. This setup enables you to monitor network
traffic, detect threats, and visualize security events through Kibana's
dashboards. To enhance your SIEM, consider: - Adding more Filebeat
modules (e.g., for Nginx or other services). - Configuring additional
Suricata rules for specific threats. - Setting up Nginx as a reverse
proxy for external Kibana access. - Exploring advanced Kibana features
like custom dashboards or machine learning for anomaly detection.

For questions or contributions, open an issue or submit a pull request
in this repository.
